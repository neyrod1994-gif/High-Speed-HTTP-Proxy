name: HTTP Proxy Helper

on:
  workflow_dispatch:

jobs:
  proxy-helper:
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
    - name: Setup Tailscale Connection
      run: |
        Write-Host "üîß Configurando conexi√≥n segura..."
        
        # Instalar Tailscale de forma segura
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        
        # Conectar a Tailscale
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-helper-$env:GITHUB_RUN_ID
        Start-Sleep -Seconds 10
        
        # Obtener IP de Tailscale
        $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        Write-Host "‚úÖ IP de Tailscale: $tsIP"

    - name: Generate Proxy Configuration
      run: |
        Write-Host "üìù Generando configuraci√≥n para HTTP Injector..."
        
        # Crear configuraci√≥n SIN servidor HTTP
        $configContent = @"
# üöÄ Configuraci√≥n para HTTP Injector
# üìç Servidor: $env:TAILSCALE_IP
# ‚è∞ Generado: $(Get-Date)

[INFORMACI√ìN]
IP_SERVIDOR = $env:TAILSCALE_IP
PUERTO = 443
PROTOCOLO = https

[PAYLOAD_SUGERIDO]
CONNECT [host_port] HTTP/1.1[crlf][crlf]
GET http://mhost.com/ [protocol][crlf]Host: mhost.com[crlf]X-Online-Host: mhost.com[crlf]Connection: Keep-Alive[crlf][crlf]

[CONFIGURACI√ìN_RECOMENDADA]
- Usar puerto: 443 (HTTPS)
- Protocolo: HTTP/HTTPS
- Payload: Personalizar seg√∫n operador
- SNI: mhost.com

[NOTAS]
1. Esta IP estar√° activa por 10 minutos
2. Usar Tailscale en el dispositivo m√≥vil
3. Configurar HTTP Injector manualmente
"@

        # Mostrar configuraci√≥n en logs
        Write-Host "üîß CONFIGURACI√ìN GENERADA:"
        Write-Host $configContent
        
        # Guardar en variable de entorno
        echo "PROXY_CONFIG=$configContent" >> $env:GITHUB_ENV

    - name: Create Configuration File
      run: |
        Write-Host "üíæ Creando archivo de configuraci√≥n..."
        
        # Crear archivo de texto simple (no ejecutable)
        $configDir = "C:\proxy-config"
        New-Item -ItemType Directory -Path $configDir -Force
        
        $fileContent = @"
Configuraci√≥n para HTTP Injector
================================
IP del Servidor: $env:TAILSCALE_IP
Tiempo Activo: 10 minutos

Payload sugerido:
CONNECT [host_port] HTTP/1.1[crlf][crlf]
GET http://mhost.com/ [protocol][crlf]Host: mhost.com[crlf]X-Online-Host: mhost.com[crlf]Connection: Keep-Alive[crlf][crlf]

Instrucciones:
1. Instalar Tailscale en tu celular
2. Conectar a la misma cuenta
3. Usar esta IP en HTTP Injector: $env:TAILSCALE_IP
4. Configurar payload manualmente
"@

        $fileContent | Out-File -FilePath "$configDir\config.txt" -Encoding UTF8
        Write-Host "‚úÖ Archivo de configuraci√≥n creado"

    - name: Show Final Instructions
      run: |
        Write-Host ""
        Write-Host "üéâ ===== CONFIGURACI√ìN LISTA ====="
        Write-Host "üìç IP DE CONEXI√ìN: $env:TAILSCALE_IP"
        Write-Host ""
        Write-Host "üì± INSTRUCCIONES PARA HTTP INJECTOR:"
        Write-Host "   1. Instala Tailscale en tu celular"
        Write-Host "   2. Con√©ctate a la misma cuenta"
        Write-Host "   3. En HTTP Injector, usa:"
        Write-Host "      - Host: $env:TAILSCALE_IP"
        Write-Host "      - Puerto: 443 (recomendado)"
        Write-Host "      - Payload: Personalizado"
        Write-Host ""
        Write-Host "üîß PAYLOAD SUGERIDO:"
        Write-Host "   CONNECT [host_port] HTTP/1.1[crlf][crlf]"
        Write-Host "   GET http://mhost.com/ [protocol][crlf]"
        Write-Host "   Host: mhost.com[crlf]"
        Write-Host "   X-Online-Host: mhost.com[crlf]"
        Write-Host "   Connection: Keep-Alive[crlf][crlf]"
        Write-Host ""
        Write-Host "‚è∞ Tiempo activo: 10 minutos"
        Write-Host "================================"

    - name: Keep Connection Active
      run: |
        Write-Host "üîÑ Manteniendo conexi√≥n activa..."
        $startTime = Get-Date
        $endTime = $startTime.AddMinutes(10)
        
        while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $minutes = [math]::Round($remaining.TotalMinutes, 1)
            
            # Verificar que Tailscale sigue conectado
            $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
            $isConnected = $tsStatus -like "*Active*"
            
            Write-Host "[$(Get-Date)] Conexi√≥n activa - $minutes min - Tailscale: $(if($isConnected){'‚úÖ'}else{'‚ùå'})"
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "üõë Conexi√≥n finalizada"
