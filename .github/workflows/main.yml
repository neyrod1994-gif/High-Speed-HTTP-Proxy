name: Lightweight Network Helper

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duraci√≥n en minutos (m√°x 5)'
        required: false
        default: '5'

jobs:
  network-helper:
    runs-on: windows-latest
    timeout-minutes: 6  # Poco tiempo para evitar abuso

    steps:
    - name: Initialize Lightweight Connection
      run: |
        Write-Host "üîß Iniciando conexi√≥n ligera..."
        
        # Descarga m√≠nima de Tailscale
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -TimeoutSec 30
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
        } catch {
            Write-Host "‚ö†Ô∏è  Error en instalaci√≥n: $($_.Exception.Message)"
        }

    - name: Establish Minimal Tailscale Connection
      run: |
        Write-Host "üì° Estableciendo conexi√≥n m√≠nima..."
        
        # Conexi√≥n simple sin caracter√≠sticas avanzadas
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-light-$env:GITHUB_RUN_ID --accept-dns=false --ssh=false
        
        Start-Sleep -Seconds 8  # Menos tiempo de espera
        
        # Obtener IP con verificaci√≥n
        $tsIP = $null
        $attempts = 0
        while (-not $tsIP -and $attempts -lt 3) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            $attempts++
            if (-not $tsIP) { Start-Sleep -Seconds 2 }
        }
        
        if ($tsIP) {
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "‚úÖ IP obtenida: $tsIP"
        } else {
            Write-Host "‚ùå No se pudo obtener IP"
            echo "TAILSCALE_IP=ERROR" >> $env:GITHUB_ENV
        }

    - name: Generate Lightweight Configuration
      run: |
        Write-Host "üìã Generando configuraci√≥n liviana..."
        
        if ($env:TAILSCALE_IP -eq "ERROR") {
            Write-Host "üö´ No se puede generar configuraci√≥n sin IP"
            exit 0
        }
        
        # Configuraci√≥n m√≠nima en memoria
        $quickConfig = @"
# ‚ö° Configuraci√≥n Ligera - GitHub Actions
# IP: $env:TAILSCALE_IP
# Generado: $(Get-Date -Format "HH:mm:ss")

CONFIGURACI√ìN R√ÅPIDA:
‚Ä¢ Host: $env:TAILSCALE_IP
‚Ä¢ Puerto: 443 (recomendado)
‚Ä¢ Timeout: 30 segundos

PAYLOAD B√ÅSICO:
[CONNECT]
[host_port] [protocol][split]

[HEADERS]  
Host: [host][crlf]X-Online-Host: [host][crlf]

NOTA: Servicio activo por ${{ github.event.inputs.duration }} minutos
"@

        Write-Host "üîß Configuraci√≥n generada en memoria"
        echo "QUICK_CONFIG=$quickConfig" >> $env:GITHUB_ENV

    - name: Display Connection Info
      run: |
        if ($env:TAILSCALE_IP -eq "ERROR") {
            Write-Host "‚ùå No se pudo establecer conexi√≥n"
            exit 0
        }
        
        Write-Host ""
        Write-Host "üéØ ===== CONEXI√ìN LIGERA LISTA ====="
        Write-Host "üìç IP: $env:TAILSCALE_IP"
        Write-Host "‚è±Ô∏è  Duraci√≥n: ${{ github.event.inputs.duration }} minutos"
        Write-Host "üíæ Recursos: M√≠nimos"
        Write-Host ""
        Write-Host "üì± Uso r√°pido:"
        Write-Host "   1. Conectar Tailscale en celular"
        Write-Host "   2. Usar IP arriba en tu app"
        Write-Host "   3. Configurar manualmente"
        Write-Host ""
        Write-Host "‚ö° Estado: ‚úÖ ACTIVO (ligero)"
        Write-Host "================================"

    - name: Maintain Lightweight Session
      run: |
        if ($env:TAILSCALE_IP -eq "ERROR") {
            Write-Host "üõë Sesi√≥n no disponible"
            exit 0
        }
        
        Write-Host "üîÑ Manteniendo sesi√≥n ligera..."
        $duration = [int]${{ github.event.inputs.duration }}
        $endTime = (Get-Date).AddMinutes($duration)
        $checkCount = 0
        
        while ((Get-Date) -lt $endTime -and $checkCount -lt 50) {
            $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
            
            # Verificaci√≥n ligera cada 30 segundos
            $tsCheck = & "$env:ProgramFiles\Tailscale\tailscale.exe" status 2>$null
            $isActive = $tsCheck -like "*Active*"
            
            if ($checkCount % 2 -eq 0) {  # Log cada 60 segundos para reducir output
                Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Sesi√≥n activa - $remaining min"
            }
            
            $checkCount++
            Start-Sleep -Seconds 30  # Intervalo m√°s largo para menos recursos
        }
        
        Write-Host "üí§ Sesi√≥n ligera finalizada"

    - name: Cleanup Minimal Resources
      run: |
        Write-Host "üßπ Limpiando recursos..."
        try {
            # Desconectar Tailscale limpiamente
            & "$env:ProgramFiles\Tailscale\tailscale.exe" down 2>$null
            Write-Host "‚úÖ Recursos liberados"
        } catch {
            Write-Host "‚ö†Ô∏è  Limpieza completada"
        }
