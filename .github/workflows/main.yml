name: High Speed HTTP Proxy

on:
  workflow_dispatch:  # Esto permite ejecuci√≥n manual

jobs:
  http-proxy:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
    - name: Install Tailscale
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-proxy-$env:GITHUB_RUN_ID
        Start-Sleep -Seconds 10
        $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

    - name: Install and Configure HTTP Proxy
      run: |
        # Descargar e instalar proxy ligero (3proxy)
        $proxyUrl = "https://github.com/3proxy/3proxy/releases/download/0.9.4/3proxy-0.9.4-x64.zip"
        $proxyPath = "$env:TEMP\3proxy.zip"
        $installDir = "C:\3proxy"
        
        Write-Host "üì• Descargando proxy..."
        Invoke-WebRequest -Uri $proxyUrl -OutFile $proxyPath
        
        # Crear directorio
        New-Item -ItemType Directory -Path $installDir -Force
        
        # Extraer y configurar
        Expand-Archive -Path $proxyPath -DestinationPath $installDir -Force
        
        # Generar password aleatorio
        Add-Type -AssemblyName System.Web
        $proxyPass = [System.Web.Security.Membership]::GeneratePassword(12, 2)
        echo "PROXY_PASSWORD=$proxyPass" >> $env:GITHUB_ENV
        
        # Crear configuraci√≥n del proxy
        $configContent = @"
daemon
nserver 8.8.8.8
nserver 1.1.1.1
timeouts 1 5 30 60 180 1800 15 60
auth strong
users proxy:CL:$proxyPass
allow proxy
proxy -p3128 -i0.0.0.0 -e$env:TAILSCALE_IP
socks -p1080 -i0.0.0.0 -e$env:TAILSCALE_IP
"@
        
        $configContent | Out-File -FilePath "$installDir\3proxy.cfg" -Encoding ASCII
        Write-Host "‚úÖ Proxy configurado"

    - name: Configure Firewall for Proxy
      run: |
        # Abrir puertos para el proxy
        netsh advfirewall firewall add rule name="HTTP Proxy" dir=in action=allow protocol=TCP localport=3128
        netsh advfirewall firewall add rule name="SOCKS Proxy" dir=in action=allow protocol=TCP localport=1080
        Write-Host "üî• Puertos 3128 (HTTP) y 1080 (SOCKS) abiertos"

    - name: Start Proxy Server
      run: |
        Write-Host "üöÄ Iniciando servidor proxy..."
        $installDir = "C:\3proxy"
        
        # Iniciar proxy en segundo plano
        Start-Process -FilePath "$installDir\3proxy.exe" -ArgumentList "$installDir\3proxy.cfg" -WindowStyle Hidden
        
        # Verificar que est√° funcionando
        Start-Sleep -Seconds 5
        $httpStatus = netstat -an | Select-String ":3128"
        $socksStatus = netstat -an | Select-String ":1080"
        
        Write-Host "üîç Estado HTTP Proxy (3128): $(if($httpStatus) {'‚úÖ ACTIVO'} else {'‚ùå INACTIVO'})"
        Write-Host "üîç Estado SOCKS Proxy (1080): $(if($socksStatus) {'‚úÖ ACTIVO'} else {'‚ùå INACTIVO'})"

    - name: Show Connection Info
      run: |
        Write-Host ""
        Write-Host "üéâ ===== PROXY HTTP/SOCKS LISTO ====="
        Write-Host "üìç IP del Servidor: $env:TAILSCALE_IP"
        Write-Host "üîë Usuario: proxy"
        Write-Host "üîí Password: $env:PROXY_PASSWORD"
        Write-Host ""
        Write-Host "üîß CONFIGURACI√ìN HTTP PROXY:"
        Write-Host "   Puerto: 3128"
        Write-Host "   Tipo: HTTP/HTTPS"
        Write-Host "   IP: $env:TAILSCALE_IP:3128"
        Write-Host ""
        Write-Host "üîß CONFIGURACI√ìN SOCKS5:"
        Write-Host "   Puerto: 1080" 
        Write-Host "   Tipo: SOCKS5"
        Write-Host "   IP: $env:TAILSCALE_IP:1080"
        Write-Host ""
        Write-Host "üöÄ Velocidad esperada: 200-500 Mbps"
        Write-Host "‚è∞ Tiempo restante: 10 minutos"
        Write-Host "================================"

    - name: Maintain Proxy Service
      run: |
        $startTime = Get-Date
        $endTime = $startTime.AddMinutes(10)
        
        while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $minutes = [math]::Round($remaining.TotalMinutes, 1)
            
            # Verificar que el proxy sigue activo
            $httpActive = netstat -an | Select-String ":3128"
            $socksActive = netstat -an | Select-String ":1080"
            
            Write-Host "[$(Get-Date)] Proxy activo - $minutes min restantes - HTTP: $(if($httpActive){'‚úÖ'}else{'‚ùå'}) SOCKS: $(if($socksActive){'‚úÖ'}else{'‚ùå'})"
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host "üõë Proxy apag√°ndose..."
